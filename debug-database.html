<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Debug Tool - Beta Website</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8f6f0 0%, #f5f1e8 100%);
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
        }
        .debug-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 2rem;
            font-weight: 300;
        }
        .debug-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
        }
        .debug-btn {
            background: linear-gradient(135deg, #d4a574, #b8860b);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            margin: 0.5rem;
            transition: all 0.3s ease;
        }
        .debug-btn:hover {
            transform: translateY(-2px);
        }
        .debug-btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        .log-output {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
        }
        .status {
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            font-weight: 500;
        }
        .status.success { background: #e8f5e8; color: #2e7d32; }
        .status.error { background: #ffebee; color: #c62828; }
        .status.warning { background: #fff3e0; color: #f57c00; }
        .status.info { background: #e3f2fd; color: #1976d2; }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>üîç Database Debug Tool</h1>
        <p>This tool helps diagnose database connection and deletion issues.</p>

        <div class="debug-section">
            <h3>üîó Connection Test</h3>
            <button class="debug-btn" onclick="testConnection()">Test Supabase Connection</button>
            <button class="debug-btn" onclick="checkTables()">Check Table Structure</button>
            <button class="debug-btn" onclick="testPermissions()">Test Permissions</button>
        </div>

        <div class="debug-section">
            <h3>üìä Data Analysis</h3>
            <button class="debug-btn" onclick="showCurrentData()">Show Current Data</button>
            <button class="debug-btn" onclick="compareLocalVsRemote()">Compare Local vs Remote</button>
            <button class="debug-btn" onclick="checkDuplicates()">Check for Duplicates</button>
        </div>

        <div class="debug-section">
            <h3>üóëÔ∏è Deletion Test</h3>
            <button class="debug-btn danger" onclick="testSingleDeletion()">Test Single Product Deletion</button>
            <button class="debug-btn danger" onclick="testBatchDeletion()">Test Batch Deletion</button>
            <button class="debug-btn" onclick="checkDeleteConstraints()">Check Delete Constraints</button>
        </div>

        <div class="debug-section">
            <h3>üîß Database Repair</h3>
            <button class="debug-btn" onclick="forceSync()">Force Sync</button>
            <button class="debug-btn danger" onclick="resetDatabase()">Reset Database</button>
            <button class="debug-btn" onclick="fixInconsistencies()">Fix Inconsistencies</button>
        </div>

        <div id="statusOutput"></div>
        <div id="logOutput" class="log-output" style="display: none;"></div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <script>
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logs.push(logEntry);
            
            const logOutput = document.getElementById('logOutput');
            logOutput.style.display = 'block';
            logOutput.textContent = logs.join('\n');
            logOutput.scrollTop = logOutput.scrollHeight;
            
            console.log(message);
        }

        function showStatus(message, type) {
            const statusOutput = document.getElementById('statusOutput');
            statusOutput.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function testConnection() {
            log('üîó Testing Supabase connection...');
            showStatus('Testing connection...', 'info');
            
            try {
                const { data, error } = await supabase.from('companies').select('count', { count: 'exact' });
                
                if (error) {
                    log(`‚ùå Connection failed: ${error.message}`, 'error');
                    showStatus(`Connection failed: ${error.message}`, 'error');
                } else {
                    log('‚úÖ Connection successful!');
                    showStatus('‚úÖ Supabase connection is working!', 'success');
                }
            } catch (error) {
                log(`‚ùå Connection error: ${error.message}`, 'error');
                showStatus(`Connection error: ${error.message}`, 'error');
            }
        }

        async function checkTables() {
            log('üìã Checking table structure...');
            showStatus('Checking tables...', 'info');
            
            try {
                // Check companies table
                const { data: companiesData, error: companiesError } = await supabase
                    .from('companies')
                    .select('*')
                    .limit(1);
                
                if (companiesError) {
                    log(`‚ùå Companies table error: ${companiesError.message}`);
                } else {
                    log(`‚úÖ Companies table exists (sample: ${JSON.stringify(companiesData[0] || 'empty')})`);
                }

                // Check products table
                const { data: productsData, error: productsError } = await supabase
                    .from('products')
                    .select('*')
                    .limit(1);
                
                if (productsError) {
                    log(`‚ùå Products table error: ${productsError.message}`);
                } else {
                    log(`‚úÖ Products table exists (sample: ${JSON.stringify(productsData[0] || 'empty')})`);
                }

                showStatus('Table structure check completed', 'success');
            } catch (error) {
                log(`‚ùå Table check error: ${error.message}`);
                showStatus(`Table check failed: ${error.message}`, 'error');
            }
        }

        async function testPermissions() {
            log('üîê Testing database permissions...');
            showStatus('Testing permissions...', 'info');
            
            try {
                // Test SELECT
                const { data: selectData, error: selectError } = await supabase
                    .from('companies')
                    .select('*')
                    .limit(1);
                
                log(selectError ? `‚ùå SELECT failed: ${selectError.message}` : '‚úÖ SELECT permission OK');

                // Test INSERT
                const testCompany = {
                    id: 'test_' + Date.now(),
                    name: 'Test Company',
                    description: 'Test Description',
                    created_at: new Date().toISOString()
                };

                const { data: insertData, error: insertError } = await supabase
                    .from('companies')
                    .insert([testCompany])
                    .select();
                
                if (insertError) {
                    log(`‚ùå INSERT failed: ${insertError.message}`);
                } else {
                    log('‚úÖ INSERT permission OK');
                    
                    // Test DELETE (clean up test data)
                    const { error: deleteError } = await supabase
                        .from('companies')
                        .delete()
                        .eq('id', testCompany.id);
                    
                    log(deleteError ? `‚ùå DELETE failed: ${deleteError.message}` : '‚úÖ DELETE permission OK');
                }

                showStatus('Permission test completed', 'success');
            } catch (error) {
                log(`‚ùå Permission test error: ${error.message}`);
                showStatus(`Permission test failed: ${error.message}`, 'error');
            }
        }

        async function showCurrentData() {
            log('üìä Fetching current data...');
            showStatus('Loading data...', 'info');
            
            try {
                // Wait for database to be ready
                if (!window.database) {
                    await new Promise(resolve => {
                        const checkDatabase = () => {
                            if (window.database) resolve();
                            else setTimeout(checkDatabase, 100);
                        };
                        checkDatabase();
                    });
                }

                const companies = window.database.getCompanies();
                const products = window.database.getProducts();
                
                log(`üìä Local Data Summary:`);
                log(`   Companies: ${companies.length}`);
                log(`   Products: ${products.length}`);
                
                companies.forEach(company => {
                    const productCount = products.filter(p => p.company === company.id).length;
                    log(`   - ${company.name} (${productCount} products) [ID: ${company.id}]`);
                });

                showStatus(`Data loaded: ${companies.length} companies, ${products.length} products`, 'success');
            } catch (error) {
                log(`‚ùå Data fetch error: ${error.message}`);
                showStatus(`Data fetch failed: ${error.message}`, 'error');
            }
        }

        async function compareLocalVsRemote() {
            log('üîÑ Comparing local vs remote data...');
            showStatus('Comparing data...', 'info');
            
            try {
                // Get local data
                const localCompanies = window.database.getCompanies();
                const localProducts = window.database.getProducts();
                
                // Get remote data
                const { data: remoteCompanies, error: companiesError } = await supabase
                    .from('companies')
                    .select('*');
                
                const { data: remoteProducts, error: productsError } = await supabase
                    .from('products')
                    .select('*');
                
                if (companiesError || productsError) {
                    log(`‚ùå Remote fetch error: ${companiesError?.message || productsError?.message}`);
                    return;
                }

                log(`üìä Data Comparison:`);
                log(`   Local Companies: ${localCompanies.length} | Remote Companies: ${remoteCompanies.length}`);
                log(`   Local Products: ${localProducts.length} | Remote Products: ${remoteProducts.length}`);
                
                // Check for differences
                const localCompanyIds = new Set(localCompanies.map(c => c.id));
                const remoteCompanyIds = new Set(remoteCompanies.map(c => c.id));
                
                const onlyLocal = [...localCompanyIds].filter(id => !remoteCompanyIds.has(id));
                const onlyRemote = [...remoteCompanyIds].filter(id => !localCompanyIds.has(id));
                
                if (onlyLocal.length > 0) {
                    log(`‚ö†Ô∏è Companies only in local: ${onlyLocal.join(', ')}`);
                }
                if (onlyRemote.length > 0) {
                    log(`‚ö†Ô∏è Companies only in remote: ${onlyRemote.join(', ')}`);
                }

                showStatus('Data comparison completed', 'success');
            } catch (error) {
                log(`‚ùå Comparison error: ${error.message}`);
                showStatus(`Comparison failed: ${error.message}`, 'error');
            }
        }

        async function testSingleDeletion() {
            log('üóëÔ∏è Testing single product deletion...');
            showStatus('Testing deletion...', 'warning');
            
            try {
                const products = window.database.getProducts();
                if (products.length === 0) {
                    log('‚ùå No products to delete');
                    showStatus('No products available for testing', 'warning');
                    return;
                }

                const testProduct = products[0];
                log(`üéØ Attempting to delete: ${testProduct.name} (ID: ${testProduct.id})`);
                
                // Perform deletion
                await window.database.deleteProduct(testProduct.id);
                
                // Verify deletion
                const updatedProducts = window.database.getProducts();
                const stillExists = updatedProducts.find(p => p.id === testProduct.id);
                
                if (stillExists) {
                    log(`‚ùå Product still exists locally after deletion!`);
                } else {
                    log(`‚úÖ Product removed from local data`);
                }

                // Check remote
                const { data: remoteProducts, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('id', testProduct.id);
                
                if (error) {
                    log(`‚ùå Error checking remote: ${error.message}`);
                } else if (remoteProducts.length > 0) {
                    log(`‚ùå Product still exists in Supabase!`);
                    showStatus('‚ùå Deletion failed - product still in database', 'error');
                } else {
                    log(`‚úÖ Product successfully deleted from Supabase`);
                    showStatus('‚úÖ Deletion test successful', 'success');
                }

            } catch (error) {
                log(`‚ùå Deletion test error: ${error.message}`);
                showStatus(`Deletion test failed: ${error.message}`, 'error');
            }
        }

        async function checkDeleteConstraints() {
            log('üîç Checking delete constraints...');
            showStatus('Checking constraints...', 'info');
            
            try {
                // Check RLS policies
                const { data, error } = await supabase.rpc('get_policies', { table_name: 'products' });
                
                if (error) {
                    log(`‚ö†Ô∏è Could not check RLS policies: ${error.message}`);
                } else {
                    log(`üìã RLS Policies found: ${data?.length || 0}`);
                }

                // Try to understand table structure
                const { data: tableInfo, error: tableError } = await supabase
                    .from('information_schema.columns')
                    .select('*')
                    .eq('table_name', 'products');
                
                if (!tableError && tableInfo) {
                    log(`üìã Products table columns: ${tableInfo.map(col => col.column_name).join(', ')}`);
                }

                showStatus('Constraint check completed', 'success');
            } catch (error) {
                log(`‚ùå Constraint check error: ${error.message}`);
                showStatus(`Constraint check failed: ${error.message}`, 'error');
            }
        }

        async function forceSync() {
            log('üîÑ Forcing database sync...');
            showStatus('Syncing...', 'info');
            
            try {
                if (window.refreshDatabase) {
                    await window.refreshDatabase();
                    log('‚úÖ Database sync completed');
                    showStatus('‚úÖ Sync completed', 'success');
                } else {
                    log('‚ùå Refresh function not available');
                    showStatus('Refresh function not available', 'error');
                }
            } catch (error) {
                log(`‚ùå Sync error: ${error.message}`);
                showStatus(`Sync failed: ${error.message}`, 'error');
            }
        }

        async function resetDatabase() {
            if (!confirm('This will completely reset the database. Are you sure?')) {
                return;
            }
            
            log('üîÑ Resetting database...');
            showStatus('Resetting database...', 'warning');
            
            try {
                // Clear all data
                await supabase.from('products').delete().neq('id', '');
                await supabase.from('companies').delete().neq('id', '');
                
                // Clear local storage
                localStorage.clear();
                
                log('‚úÖ Database reset completed');
                showStatus('‚úÖ Database reset completed', 'success');
                
                // Reload page
                setTimeout(() => location.reload(), 2000);
            } catch (error) {
                log(`‚ùå Reset error: ${error.message}`);
                showStatus(`Reset failed: ${error.message}`, 'error');
            }
        }

        // Auto-run connection test on load
        window.addEventListener('load', () => {
            setTimeout(testConnection, 1000);
        });
    </script>
</body>
</html>
