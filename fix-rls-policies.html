<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix RLS Policies - Supabase</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 2rem; background: #f5f5f5; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .alert { padding: 1rem; margin: 1rem 0; border-radius: 5px; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .code-block { background: #f8f9fa; padding: 1rem; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 0.9rem; overflow-x: auto; margin: 1rem 0; border-left: 4px solid #007bff; }
        .step { margin: 2rem 0; padding: 1rem; border: 1px solid #dee2e6; border-radius: 5px; }
        .step h3 { color: #495057; margin-top: 0; }
        button { padding: 0.75rem 1.5rem; margin: 0.5rem; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí Fix Supabase Row Level Security (RLS) Policies</h1>
        
        <div class="alert alert-danger">
            <h4>‚ö†Ô∏è Issue Identified</h4>
            <p>Your Supabase database has Row Level Security (RLS) enabled, but no policies are configured to allow INSERT, UPDATE, or DELETE operations. This is why your admin panel deletions aren't working.</p>
        </div>

        <div class="step">
            <h3>üéØ Solution Options</h3>
            <p>Choose one of these approaches:</p>
            
            <button class="btn-warning" onclick="showDisableRLS()">Option 1: Disable RLS (Quick Fix)</button>
            <button class="btn-primary" onclick="showCreatePolicies()">Option 2: Create Proper RLS Policies (Recommended)</button>
            <button class="btn-success" onclick="testCurrentSetup()">Test Current Setup</button>
        </div>

        <div id="solution-content"></div>

        <div class="step">
            <h3>üîß Quick Test</h3>
            <button class="btn-primary" onclick="testDirectOperations()">Test Direct Database Operations</button>
            <div id="test-results"></div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <script>
        function showDisableRLS() {
            document.getElementById('solution-content').innerHTML = `
                <div class="alert alert-warning">
                    <h4>‚ö° Option 1: Disable RLS (Quick Fix)</h4>
                    <p>This is the fastest solution but less secure. Good for development/testing.</p>
                </div>
                
                <div class="step">
                    <h3>üìã Steps to Disable RLS:</h3>
                    <ol>
                        <li>Go to your <strong>Supabase Dashboard</strong></li>
                        <li>Navigate to <strong>Table Editor</strong></li>
                        <li>For each table (<code>companies</code> and <code>products</code>):</li>
                        <ul>
                            <li>Click the table name</li>
                            <li>Click the <strong>‚öôÔ∏è Settings</strong> icon</li>
                            <li>Find <strong>"Enable Row Level Security"</strong></li>
                            <li>Toggle it <strong>OFF</strong></li>
                            <li>Click <strong>Save</strong></li>
                        </ul>
                    </ol>
                </div>

                <div class="alert alert-info">
                    <h4>üîó Alternative: SQL Commands</h4>
                    <p>You can also run these SQL commands in the Supabase SQL Editor:</p>
                    <div class="code-block">
ALTER TABLE companies DISABLE ROW LEVEL SECURITY;
ALTER TABLE products DISABLE ROW LEVEL SECURITY;</div>
                </div>

                <button class="btn-success" onclick="testAfterDisabling()">Test After Disabling RLS</button>
            `;
        }

        function showCreatePolicies() {
            document.getElementById('solution-content').innerHTML = `
                <div class="alert alert-success">
                    <h4>üõ°Ô∏è Option 2: Create Proper RLS Policies (Recommended)</h4>
                    <p>This maintains security while allowing your admin operations.</p>
                </div>
                
                <div class="step">
                    <h3>üìã Steps to Create RLS Policies:</h3>
                    <ol>
                        <li>Go to your <strong>Supabase Dashboard</strong></li>
                        <li>Navigate to <strong>SQL Editor</strong></li>
                        <li>Run the following SQL commands:</li>
                    </ol>
                    
                    <h4>For Companies Table:</h4>
                    <div class="code-block">
-- Enable RLS on companies table
ALTER TABLE companies ENABLE ROW LEVEL SECURITY;

-- Allow all operations for authenticated users (you can make this more restrictive)
CREATE POLICY "Allow all operations on companies" ON companies
    FOR ALL USING (true) WITH CHECK (true);

-- Or if you want to allow anonymous access (less secure):
-- CREATE POLICY "Allow all operations on companies" ON companies
--     FOR ALL USING (true) WITH CHECK (true);</div>

                    <h4>For Products Table:</h4>
                    <div class="code-block">
-- Enable RLS on products table
ALTER TABLE products ENABLE ROW LEVEL SECURITY;

-- Allow all operations for authenticated users
CREATE POLICY "Allow all operations on products" ON products
    FOR ALL USING (true) WITH CHECK (true);</div>

                    <h4>More Secure Alternative (Admin Only):</h4>
                    <div class="code-block">
-- Create policies that only allow operations for admin users
-- (You'll need to implement proper authentication)

CREATE POLICY "Admin can manage companies" ON companies
    FOR ALL USING (
        auth.jwt() ->> 'role' = 'admin' OR 
        auth.jwt() ->> 'email' = 'admin@yourdomain.com'
    ) WITH CHECK (
        auth.jwt() ->> 'role' = 'admin' OR 
        auth.jwt() ->> 'email' = 'admin@yourdomain.com'
    );

CREATE POLICY "Admin can manage products" ON products
    FOR ALL USING (
        auth.jwt() ->> 'role' = 'admin' OR 
        auth.jwt() ->> 'email' = 'admin@yourdomain.com'
    ) WITH CHECK (
        auth.jwt() ->> 'role' = 'admin' OR 
        auth.jwt() ->> 'email' = 'admin@yourdomain.com'
    );</div>
                </div>

                <button class="btn-success" onclick="testAfterPolicies()">Test After Creating Policies</button>
            `;
        }

        function showCurrentSetup() {
            document.getElementById('solution-content').innerHTML = `
                <div class="alert alert-info">
                    <h4>üìä Current Database Setup</h4>
                    <p>Analyzing your current Supabase configuration...</p>
                </div>
                <div id="setup-analysis">Loading...</div>
            `;
            
            analyzeCurrentSetup();
        }

        async function analyzeCurrentSetup() {
            const analysisDiv = document.getElementById('setup-analysis');
            let analysis = '';
            
            try {
                // Test basic operations
                analysis += '<h4>üîç Analysis Results:</h4>';
                
                // Test SELECT
                const { data: selectData, error: selectError } = await supabase
                    .from('companies')
                    .select('*')
                    .limit(1);
                
                analysis += selectError ? 
                    '<p>‚ùå SELECT: Failed - ' + selectError.message + '</p>' :
                    '<p>‚úÖ SELECT: Working</p>';

                // Test INSERT
                const testId = 'test_' + Date.now();
                const { data: insertData, error: insertError } = await supabase
                    .from('companies')
                    .insert([{
                        id: testId,
                        name: 'Test Company',
                        description: 'Test Description',
                        created_at: new Date().toISOString()
                    }])
                    .select();
                
                if (insertError) {
                    analysis += '<p>‚ùå INSERT: Failed - ' + insertError.message + '</p>';
                } else {
                    analysis += '<p>‚úÖ INSERT: Working</p>';
                    
                    // Test DELETE (clean up)
                    const { error: deleteError } = await supabase
                        .from('companies')
                        .delete()
                        .eq('id', testId);
                    
                    analysis += deleteError ? 
                        '<p>‚ùå DELETE: Failed - ' + deleteError.message + '</p>' :
                        '<p>‚úÖ DELETE: Working</p>';
                }

                analysisDiv.innerHTML = analysis;
                
            } catch (error) {
                analysisDiv.innerHTML = '<p>‚ùå Analysis failed: ' + error.message + '</p>';
            }
        }

        async function testCurrentSetup() {
            showCurrentSetup();
        }

        async function testDirectOperations() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p>üîÑ Testing direct operations...</p>';
            
            let results = '<h4>üß™ Test Results:</h4>';
            
            try {
                // Test product deletion
                const { data: products } = await supabase
                    .from('products')
                    .select('*')
                    .limit(1);
                
                if (products && products.length > 0) {
                    const testProduct = products[0];
                    results += '<p>üéØ Testing deletion of: ' + testProduct.name + '</p>';
                    
                    const { error: deleteError } = await supabase
                        .from('products')
                        .delete()
                        .eq('id', testProduct.id);
                    
                    if (deleteError) {
                        results += '<p>‚ùå DELETE failed: ' + deleteError.message + '</p>';
                        results += '<div class="alert alert-danger">This confirms the RLS policy issue. You need to fix the policies as shown above.</div>';
                    } else {
                        results += '<p>‚úÖ DELETE successful!</p>';
                        results += '<div class="alert alert-success">Great! Deletions are working now.</div>';
                    }
                } else {
                    results += '<p>‚ö†Ô∏è No products found to test deletion</p>';
                }
                
            } catch (error) {
                results += '<p>‚ùå Test error: ' + error.message + '</p>';
            }
            
            resultsDiv.innerHTML = results;
        }

        async function testAfterDisabling() {
            document.getElementById('solution-content').innerHTML += `
                <div class="alert alert-info">
                    <h4>üß™ Testing After Disabling RLS...</h4>
                    <div id="disable-test-results">Running tests...</div>
                </div>
            `;
            
            setTimeout(async () => {
                await testDirectOperations();
                document.getElementById('disable-test-results').innerHTML = 'Test completed. Check results below.';
            }, 1000);
        }

        async function testAfterPolicies() {
            document.getElementById('solution-content').innerHTML += `
                <div class="alert alert-info">
                    <h4>üß™ Testing After Creating Policies...</h4>
                    <div id="policies-test-results">Running tests...</div>
                </div>
            `;
            
            setTimeout(async () => {
                await testDirectOperations();
                document.getElementById('policies-test-results').innerHTML = 'Test completed. Check results below.';
            }, 1000);
        }
    </script>
</body>
</html>
